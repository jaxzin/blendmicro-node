#!/usr/bin/env coffee

optparse = require 'optparse'
util     = require 'util'

parser = new optparse.OptionParser [
  ['-h', '--help',     'show help']
  ['-l', '--list',     'list devices']
  ['-t', '--terminal', 'BLE terminal mode']
]

unless process.argv[2]
  process.argv[2] = '--help'

parser.on 'help', ->
  package_json = require "#{__dirname}/../package.json"

  parser.banner = """
  #{package_json.name} v#{package_json.version}

  Usage:
    % #{package_json.name} --list
    % #{package_json.name} --terminal BlendMicro
  """
  
  console.log parser.toString()
  process.exit 0

parser.on 'list', ->
  console.log 'scanning devices..'
  noble = require 'noble'
  sys   = require 'sys'
  noble.on 'discover', (peripheral) ->
    console.log peripheral.advertisement.localName
    for k,v of peripheral.advertisement
      console.log "  #{k}\t#{util.inspect v}"

  noble.startScanning()

parser.on 'terminal', (device_name) ->
  BlendMicro = require "#{__dirname}/../"


parser.parse process.argv

